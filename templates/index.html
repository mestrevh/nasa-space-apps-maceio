<!doctype html>
<html>
<head>
    <title>Document Analysis with Neo4j</title>
    <script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <style>
        /* Dark Theme Styles */
        body {
            font-family: system-ui, sans-serif;
            margin: 0;
            display: flex;
            height: 100vh;
            background-color: #1a1a1a; /* Dark background for the main content area */
            color: #e0e0e0; /* Light text color for readability */
        }
        .sidebar {
            width: 350px;
            padding: 20px;
            background-color: #282828; /* Slightly lighter dark for sidebar */
            border-right: 1px solid #3a3a3a; /* Darker border */
            box-shadow: 2px 0 5px rgba(0,0,0,0.5); /* More pronounced shadow for depth */
            overflow-y: auto;
        }
        .main-content {
            flex-grow: 1;
        }
        #mynetwork {
            width: 100%;
            height: 100%;
            background-color: #1a1a1a; /* Ensure the network background matches body */
        }
        h1, h2 {
            color: #f0f0f0; /* Lighter color for headings */
        }
        p {
            color: #c0c0c0; /* Slightly desaturated text for paragraphs */
        }
        form {
            margin-top: 20px;
        }
        input[type="file"] {
            border: 1px solid #555; /* Darker border for input */
            padding: 8px;
            border-radius: 4px;
            width: 100%;
            background-color: #333; /* Dark input background */
            color: #e0e0e0; /* Light text for input */
        }
        button {
            background-color: #4a90e2; /* A shade of blue for buttons */
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
            font-size: 16px;
        }
        button:hover {
            background-color: #357bd8; /* Darker blue on hover */
        }
        #status {
            margin-top: 15px;
            padding: 10px;
            border-radius: 4px;
            background-color: #3a3a3a; /* Dark background for status messages */
            color: #c0c0c0; /* Light text for status messages */
        }

        /* NEW STYLE: Changes cursor on hover over a node in Vis.js */
        #mynetwork .vis-network .vis-node:hover {
            cursor: pointer;
        }
        /* Optional: Vis.js specific styles for dark theme if you want to customize nodes/edges */
        .vis-tooltip {
            background-color: #333 !important;
            color: #e0e0e0 !important;
            border: 1px solid #555 !important;
        }
    </style>
</head>
<body>

    <div class="sidebar">
        <h1>PDF Analysis</h1>
        <p>Upload a PDF document to extract entities and relationships, and view them in the graph.</p>
        <p><strong>üí° Dica:</strong> Clique em qualquer n√≥ para ver a revis√£o sistem√°tica!</p>
        
        <form id="upload-form">
            <input type="file" id="pdf-input" name="pdf_file" accept=".pdf" required>
            <button type="submit">Process PDF</button>
        </form>

        <div id="status">Ready to receive a file.</div>
    </div>

    <div class="main-content">
        <div id="mynetwork"></div>
    </div>

<script type="text/javascript">
    const container = document.getElementById('mynetwork');
    const statusDiv = document.getElementById('status');
    const uploadForm = document.getElementById('upload-form');
    const pdfInput = document.getElementById('pdf-input');
    
    let network = null;
    // We need to access the DataSet of nodes, so we declare it here
    let nodesDataSet = new vis.DataSet([]); 
    let edgesDataSet = new vis.DataSet([]);

    // 1. Function to draw or update the graph
    function drawGraph(graphData) {
        // Process nodes to add visual grouping based on articles
        const processedNodes = graphData.nodes.map((node, index) => {
            const processedNode = { ...node };
            
            // Override the group to use articleGroup for visual separation
            if (node.articleGroup) {
                processedNode.group = node.articleGroup;
            }
            
            // Add visual properties based on article group with more spacing
            if (node.articleGroup === 'article1') {
                // Article 1 nodes on the left side with more spacing
                processedNode.x = -500 + (index % 3) * 150;
                processedNode.y = -300 + Math.floor(index / 3) * 200;
                processedNode.fixed = { x: false, y: false };
            } else if (node.articleGroup === 'article2') {
                // Article 2 nodes on the right side with more spacing
                processedNode.x = 500 + (index % 3) * 150;
                processedNode.y = -300 + Math.floor(index / 3) * 200;
                processedNode.fixed = { x: false, y: false };
            } else {
                // Shared nodes in the middle with more spacing
                processedNode.x = (index % 2) * 100 - 50;
                processedNode.y = -150 + Math.floor(index / 2) * 150;
                processedNode.fixed = { x: false, y: false };
            }
            
            return processedNode;
        });
        
        // Clear old data and add new
        nodesDataSet.clear();
        edgesDataSet.clear();
        nodesDataSet.add(processedNodes);
        edgesDataSet.add(graphData.edges);

        const data = {
            nodes: nodesDataSet,
            edges: edgesDataSet
        };

        const options = {
            interaction: {
                hover: true // Enable hover effects, necessary for cursor change
            },
            // Layout and physics settings for better spacing - no overlap
            physics: {
                enabled: true,
                stabilization: { iterations: 400 },
                barnesHut: {
                    gravitationalConstant: -5000,
                    centralGravity: 0.03,
                    springLength: 500,
                    springConstant: 0.01,
                    damping: 0.2,
                    avoidOverlap: 1.5
                }
            },
            layout: {
                improvedLayout: true,
                clusterThreshold: 400,
                hierarchical: {
                    enabled: false
                }
            },
            // Improved node styling - circular and larger with no overlap
            nodes: {
                font: { 
                    color: '#ffffff',
                    size: 14,
                    face: 'arial',
                    multi: true,
                    strokeWidth: 3,
                    strokeColor: '#000000'
                },
                borderWidth: 3,
                borderWidthSelected: 4,
                shadow: {
                    enabled: true,
                    color: 'rgba(0,0,0,0.4)',
                    size: 8,
                    x: 3,
                    y: 3
                },
                shape: 'circle',
                size: 30,
                margin: 25,
                chosen: true,
                chosenNode: function(values, id, selected, hovering) {
                    values.size = values.size * 1.2;
                }
            },
            edges: {
                color: { 
                    color: '#888888',
                    highlight: '#ffffff',
                    hover: '#cccccc'
                },
                font: { 
                    color: '#e0e0e0',
                    size: 12,
                    strokeWidth: 0,
                    background: 'rgba(0,0,0,0.7)',
                    strokeColor: '#000000'
                },
                width: 3,
                smooth: {
                    type: 'continuous',
                    forceDirection: 'none',
                    roundness: 0.2
                },
                arrows: {
                    to: {
                        enabled: true,
                        scaleFactor: 1.2,
                        type: 'arrow'
                    }
                }
            },
            // Define colors for different node types
            groups: {
                // Article 1 group (left side) - Blue tones
                article1: {
                    color: { 
                        background: '#4A90E2',
                        border: '#357ABD',
                        highlight: { background: '#5BA0F2', border: '#4A90E2' }
                    },
                    font: { color: '#ffffff', size: 14, strokeWidth: 3, strokeColor: '#000000' },
                    size: 35
                },
                // Article 2 group (right side) - Green tones  
                article2: {
                    color: { 
                        background: '#7ED321',
                        border: '#5BA817',
                        highlight: { background: '#8EE331', border: '#7ED321' }
                    },
                    font: { color: '#ffffff', size: 14, strokeWidth: 3, strokeColor: '#000000' },
                    size: 35
                },
                // Shared nodes (middle) - Orange tones
                shared: {
                    color: { 
                        background: '#F5A623',
                        border: '#D18A1F',
                        highlight: { background: '#F5B633', border: '#F5A623' }
                    },
                    font: { color: '#ffffff', size: 14, strokeWidth: 3, strokeColor: '#000000' },
                    size: 32
                },
                Paper: { 
                    color: { 
                        background: '#4A90E2',
                        border: '#357ABD',
                        highlight: { background: '#5BA0F2', border: '#4A90E2' },
                        hover: { background: '#6BA3F5', border: '#4A90E2' }
                    },
                    font: { color: '#ffffff', size: 14, strokeWidth: 3, strokeColor: '#000000' },
                    size: 35,
                    chosen: true,
                    chosenNode: function(values, id, selected, hovering) {
                        values.size = values.size * 1.3;
                        values.borderWidth = 4;
                    }
                },
                Author: { 
                    color: { 
                        background: '#7ED321',
                        border: '#5BA817',
                        highlight: { background: '#8EE331', border: '#7ED321' },
                        hover: { background: '#8EE331', border: '#7ED321' }
                    },
                    font: { color: '#ffffff', size: 14, strokeWidth: 3, strokeColor: '#000000' },
                    size: 30,
                    chosen: true,
                    chosenNode: function(values, id, selected, hovering) {
                        values.size = values.size * 1.2;
                        values.borderWidth = 3;
                    }
                },
                Institution: { 
                    color: { 
                        background: '#F5A623',
                        border: '#D18A1F',
                        highlight: { background: '#F5B633', border: '#F5A623' },
                        hover: { background: '#F5B633', border: '#F5A623' }
                    },
                    font: { color: '#ffffff', size: 14, strokeWidth: 3, strokeColor: '#000000' },
                    size: 32,
                    chosen: true,
                    chosenNode: function(values, id, selected, hovering) {
                        values.size = values.size * 1.2;
                        values.borderWidth = 3;
                    }
                },
                Keyword: { 
                    color: { 
                        background: '#BD10E0',
                        border: '#9D0DC0',
                        highlight: { background: '#CD20F0', border: '#BD10E0' },
                        hover: { background: '#CD20F0', border: '#BD10E0' }
                    },
                    font: { color: '#ffffff', size: 14, strokeWidth: 3, strokeColor: '#000000' },
                    size: 28,
                    chosen: true,
                    chosenNode: function(values, id, selected, hovering) {
                        values.size = values.size * 1.2;
                        values.borderWidth = 3;
                    }
                },
                CellType: { 
                    color: { 
                        background: '#50E3C2',
                        border: '#40C3A2',
                        highlight: { background: '#60F3D2', border: '#50E3C2' },
                        hover: { background: '#60F3D2', border: '#50E3C2' }
                    },
                    font: { color: '#ffffff', size: 14, strokeWidth: 3, strokeColor: '#000000' },
                    size: 30,
                    chosen: true,
                    chosenNode: function(values, id, selected, hovering) {
                        values.size = values.size * 1.2;
                        values.borderWidth = 3;
                    }
                },
                Gene: { 
                    color: { 
                        background: '#B8E986',
                        border: '#98C966',
                        highlight: { background: '#C8F996', border: '#B8E986' },
                        hover: { background: '#C8F996', border: '#B8E986' }
                    },
                    font: { color: '#ffffff', size: 14, strokeWidth: 3, strokeColor: '#000000' },
                    size: 28,
                    chosen: true,
                    chosenNode: function(values, id, selected, hovering) {
                        values.size = values.size * 1.2;
                        values.borderWidth = 3;
                    }
                },
                Method: { 
                    color: { 
                        background: '#D0021B',
                        border: '#B0020B',
                        highlight: { background: '#E0122B', border: '#D0021B' },
                        hover: { background: '#E0122B', border: '#D0021B' }
                    },
                    font: { color: '#ffffff', size: 14, strokeWidth: 3, strokeColor: '#000000' },
                    size: 32,
                    chosen: true,
                    chosenNode: function(values, id, selected, hovering) {
                        values.size = values.size * 1.2;
                        values.borderWidth = 3;
                    }
                },
                Material: { 
                    color: { 
                        background: '#9013FE',
                        border: '#7003DE',
                        highlight: { background: '#A023FE', border: '#9013FE' },
                        hover: { background: '#A023FE', border: '#9013FE' }
                    },
                    font: { color: '#ffffff', size: 14, strokeWidth: 3, strokeColor: '#000000' },
                    size: 30,
                    chosen: true,
                    chosenNode: function(values, id, selected, hovering) {
                        values.size = values.size * 1.2;
                        values.borderWidth = 3;
                    }
                },
                Funder: { 
                    color: { 
                        background: '#417505',
                        border: '#315505',
                        highlight: { background: '#518505', border: '#417505' },
                        hover: { background: '#518505', border: '#417505' }
                    },
                    font: { color: '#ffffff', size: 14, strokeWidth: 3, strokeColor: '#000000' },
                    size: 28,
                    chosen: true,
                    chosenNode: function(values, id, selected, hovering) {
                        values.size = values.size * 1.2;
                        values.borderWidth = 3;
                    }
                },
                Mission: { 
                    color: { 
                        background: '#FF6900',
                        border: '#DF4900',
                        highlight: { background: '#FF7910', border: '#FF6900' },
                        hover: { background: '#FF7910', border: '#FF6900' }
                    },
                    font: { color: '#ffffff', size: 14, strokeWidth: 3, strokeColor: '#000000' },
                    size: 35,
                    chosen: true,
                    chosenNode: function(values, id, selected, hovering) {
                        values.size = values.size * 1.2;
                        values.borderWidth = 3;
                    }
                }
            }
        };

        network = new vis.Network(container, data, options);

        // Force stabilization to prevent overlap
        network.on('stabilizationIterationsDone', function() {
            network.setOptions({
                physics: {
                    enabled: false
                }
            });
        });

        // Add tooltip functionality
        network.on('hoverNode', function(params) {
            if (params.node) {
                const node = nodesDataSet.get(params.node);
                if (node && node.fullLabel) {
                    // Show tooltip with full text
                    const tooltip = document.createElement('div');
                    tooltip.className = 'vis-tooltip';
                    
                    // Add click instruction for all nodes
                    let tooltipContent = node.fullLabel;
                    tooltipContent += '<br><br><strong style="color: #4A90E2;">üìö Clique para ver a revis√£o sistem√°tica!</strong>';
                    
                    tooltip.innerHTML = tooltipContent;
                    tooltip.style.position = 'absolute';
                    tooltip.style.background = '#333';
                    tooltip.style.color = '#e0e0e0';
                    tooltip.style.padding = '8px';
                    tooltip.style.borderRadius = '4px';
                    tooltip.style.border = '1px solid #555';
                    tooltip.style.fontSize = '12px';
                    tooltip.style.maxWidth = '300px';
                    tooltip.style.zIndex = '1000';
                    tooltip.style.pointerEvents = 'none';
                    
                    document.body.appendChild(tooltip);
                    
                    // Position tooltip near cursor
                    const updateTooltip = (e) => {
                        tooltip.style.left = (e.clientX + 10) + 'px';
                        tooltip.style.top = (e.clientY - 10) + 'px';
                    };
                    
                    document.addEventListener('mousemove', updateTooltip);
                    
                    // Remove tooltip when mouse leaves node
                    network.on('blurNode', function() {
                        document.body.removeChild(tooltip);
                        document.removeEventListener('mousemove', updateTooltip);
                    });
                }
            }
        });

        // --- THE MAGIC HAPPENS HERE ---
        // Add a listener for click events on the network
        network.on('click', function(params) {
            // Check if a node was clicked (and not the graph background)
            if (params.nodes.length > 0) {
                const nodeId = params.nodes[0];
                const node = nodesDataSet.get(nodeId); // Get full node data

                if (node && node.label) {
                    // Redirect all nodes to systematic review page
                    console.log(`Redirecting to systematic review for ${node.group} node: ${node.label}`);
                    window.location.href = '/systematic-review';
                }
            }
        });
    }

    // Rest of the JavaScript (updateGraph, uploadForm, etc.) remains the same
    // 2. Function to fetch graph data from the API and draw
    function updateGraph() {
        statusDiv.textContent = 'Updating graph visualization...';
        fetch('/api/data')
            .then(response => response.json())
            .then(data => {
                drawGraph(data);
                statusDiv.textContent = 'Graph updated.';
            })
            .catch(error => {
                console.error('Error fetching graph data:', error);
                statusDiv.textContent = 'Error updating the graph.';
            });
    }

    // 3. Logic for the upload form
    uploadForm.addEventListener('submit', function(event) {
        event.preventDefault(); // Prevents the traditional form submission
        
        const formData = new FormData();
        formData.append('pdf_file', pdfInput.files[0]);

        statusDiv.textContent = 'Uploading file...';

        fetch('/upload', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(result => {
            if (result.error) {
                throw new Error(result.error);
            }
            console.log('Success:', result);
            statusDiv.innerHTML = `<b>${result.message}</b><br>
                                   Entities: ${result.entities_found}<br>
                                   Relationships: ${result.relationships_found}`;
            // After success, update the graph visualization
            updateGraph();
        })
        .catch(error => {
            console.error('Error:', error);
            statusDiv.textContent = `Processing error: ${error.message}`;
        });
    });

    // 4. Load the initial graph when the page opens
    document.addEventListener('DOMContentLoaded', updateGraph);
</script>

</body>
</html>